<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">

  <!-- Load the Google Platform Library -->
  <script src="https://apis.google.com/js/platform.js" async defer></script>
  <!-- Specify your app's client ID I need to enter my client ID here securely-->
  <meta name="google-signin-client_id" content="104817432499-39gk40hrs5sab2pr0ursdf73o44o6g6d.apps.googleusercontent.com">
  <title>Hacker Jedi</title>
  <!-- resource: https://www.w3schools.com/bootstrap/bootstrap_get_started.asp MaxCDN provides CDN support for Bootstrap's CSS and JavaScript. You must also include jQuery: -->
  <!-- STYLESHEETS CSS -->
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">    
  <!-- VENDOR SCRIPTS jQuery library -->
  <script
  src="https://code.jquery.com/jquery-3.3.1.min.js"
  integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
  crossorigin="anonymous"></script>
  
 <!-- Siri added these scripts! -->
  <script src="//ajax.googleapis.com/ajax/libs/jquery/2.2.2/jquery.min.js"></script>
  <script src="/scripts/app.js" defer></script>
  
</head>


<body>
  <h1>Welcome to Hacker Jedi app</h1>
  
  <a href="./profile"> go to user profile </a> -->
  <!-- add create user plus  -->

  <div>
    <div>Do you like add a new apprenticeship?</div>
      <a href="./createUser.html">Add +</a>
  </div>

  <h1>Login using Google Auth</h1>
  <!-- Add a Google Sign-In button -->
  <div class="g-signin2" data-onsuccess="onSignIn"></div>

  <script>
  //script won't work when in app.js, but will work here.... hmmmm.... suspicious....

  function onSignIn(googleUser) {
    console.log('fired');
    // debugger;
    console.log('googleUser?: ' + googleUser);
    let profile = googleUser.getBasicProfile();
    console.log('ID: ' + profile.getId()); // Do not send to your backend! Use an ID token instead.
    console.log('Name: ' + profile.getName());
    console.log('Image URL: ' + profile.getImageUrl());
    console.log('Email: ' + profile.getEmail());
    // This is null if the 'email' scope is not present.
    // access specific variables through local storage.
    // Go to console googleUser.getBasicProfile().U3 == > email "heggyy@gmail.com"

    // profile.U3 is googleUser.getBasicProfile().U3 which is an email of the user
    console.log(`Gmail email: ${profile.U3}`);
    console.log(`Gmail email: ${profile.getEmail()}`);
    console.log(`Gmail Name: ${profile.getName()}`);
    //put ajax request here

    $.ajax({
      method: 'GET',
      url: `user/${profile.getEmail()}`,
      // dbUser is the obj we get from backend
      success: function( dbUser ) {
        console.log(`dbUser is what?  ${dbUser}`);
        // if user is not saved inside of database
        //  then 
        if (dbUser === null){
          //ajax post create user
          $.ajax({
            method: 'POST',
            url: '/user',
            //  passing in user data from Google Oauth
            data: {
              name: profile.getName(),
              email: profile.getEmail(),
            },
            success: function(dbUser){
              debugger;
              // when user login using googleOauth> memory gets saved
              //  inside of localStorage and .user has the email address
              localStorage.user = dbUser;
              console.log(dbUser);
            },
            error: function(err){
              console.log(err)
            }
          })
        }
        console.log('db user',dbUser);
        localStorage.user = dbUser;
        // redirecting to add page
        // add conditional if user is from local host
        //  then redirect to http://localhost:3000/add"
        // if user is on heroku 
        //  then https://evening-forest-40933.herokuapp.com/add
        // location.href= "http://localhost:3000/add";
        location.href= "/add";
      }, // end of ajax success 
      error: function() {
        alert('There was an error');
      }
    }); // end of ajax
    
  }
  </script>

  <a href="#" id="mainSignOut">Sign out</a>
  <!-- <a href="" id ="signOut">Sign out</a> -->
  <!-- to get to the id: googleUser.getBasicProfile().getId(); -->
  
  <footer>
    <p>&copy; 2019 Siri, Chike, Heggy</p>

    <p>
      ## Credits
    </p>
  </footer>

<button id="gmailUserSubmit">Submit</button>

<a href="./profile"> go to user profile </a>
<div>
  <ul id="apprList">
      
  </ul>
</div>      

<script>
  //script won't work when in app.js, but will work here.... hmmmm.... suspicious....
  // google oAuth log out function
  $('#mainSignOut').click(function() {
    var auth2 = gapi.auth2.getAuthInstance();
    auth2.signOut().then(function () {
      localStorage.removeItem('user')
      console.log('User signed out.');
    });
  });

</script>


</body>
</html>